const plotly_username = 'bm782';
const plotly_key = 'exlLYbcR6MdCfdqHn7xR';
const fs = require('fs');
const { DateTime } = require("luxon");

let plotly = require('plotly')(plotly_username, plotly_key);

exports.handler = async(event) => {
    try {
        let existingData = setupExistingData();
        let rawdata = fs.readFileSync('predictions.json');
        let JSONdata = JSON.parse(rawdata);
        let yValues = JSONdata.predictions[0].mean;
        let startDateTime = DateTime.fromISO("2020-06-04T17:00:00") // Thu 4th JUne 2020, 17:00:00
        let xValues = [];
        let dateString = startDateTime.toISO();
        xValues.push(dateString);
        for (let i = 1; i < yValues.length; i++) {
            startDateTime = startDateTime.plus({ hours: 1 });
            dateString = startDateTime.toISO();;
            xValues.push(dateString)
        }

        let plotResult = await plotData(xValues, yValues, existingData[0], existingData[1]);
        console.log("Plot availible at " + plotResult.url)

        return {
            statusCode: 200,
            body: "Ok"
        }
    } catch (err) {
        console.log("Error: " + JSON.stringify(err));
        return {
            statusCode: 500,
            body: "Error"
        }
    }
}

async function plotData(xValues, yValues, existingx, existingy) {
    let data = [{
        x: existingx,
        y: existingy,
        type: "scatter",
        mode: "line",
        name: "Existing data",
        marker: {
            color: "rgb(82, 64, 219)",
            size: 12
        }
    }, {
        x: xValues,
        y: yValues,
        type: "scatter",
        mode: "line",
        name: "Mean prediction",
        marker: {
            color: "rgb(219, 64, 82)",
            size: 12
        }
    }]

    let layout = {
        title: "Synthetic Data",
        font: {
            size: 25
        },
        xaxis: {
            title: "Time (hours)"
        },
        yaxis: {
            title: "Value"
        }
    };

    let graphOptions = {
        layout: layout,
        filename: "dateaxes",
        fileopt: "overwrite"
    };

    return new Promise((resolve, reject) => {
        plotly.plot(data, graphOptions, function(err, msg) {
            if (err)
                reject(err);
            else {
                resolve(msg);
            }
        })
    })
};

function setupExistingData() {
    let startDateTime = DateTime.fromISO("2020-05-14T21:00:00");
    console.log(startDateTime);
    let xValues = [];
    let dateString = startDateTime.toISO();
    console.log(dateString);
    xValues.push(dateString);
    for (let i = 1; i < 500; i++) {
        startDateTime = startDateTime.plus({ hours: 1 });
        dateString = startDateTime.toISO();;
        xValues.push(dateString)
        console.log(dateString)
    }
    return [xValues, [17.2349240760253, 18.091966166920532, 18.069501560791114, 18.976497613393786, 20.658073344073678, 19.590489505279834, 19.50082030139446, 20.638390508029218, 19.817685644825563, 20.3115476797988, 19.72858488669363, 17.819043782275983, 18.15495602107906, 16.038946575442193, 15.308727800708155, 15.615820560780634, 15.563546092045225, 14.153778574550717, 14.394017084977731, 15.708075141176874, 14.668864827996334, 15.665025863880038, 17.50831351218788, 17.102786671627765, 18.868758438208758, 19.503998223591314, 19.4625831050368, 21.09321742412285, 22.589602128380495, 22.370361520629316, 23.372567592112386, 23.206118128957232, 22.943445614888923, 22.433861906857924, 21.628450997658042, 20.364288677029837, 19.8020517055981, 19.579690660506383, 18.13500212045291, 17.18840277431947, 16.746550467611993, 17.573083916051207, 17.532794643489673, 17.334225455701365, 17.733785031531024, 18.10148534396791, 18.761759310138423, 19.584711814379954, 20.407916004279826, 21.54765581749998, 22.12198147742314, 22.875732597285776, 24.883374046697547, 24.621605960142485, 23.79612752861565, 23.873617241130496, 25.108143960787196, 24.436861243616107, 23.68205384823843, 22.98365702658435, 20.749952122090143, 21.432251217815164, 20.28558143909357, 19.53939256323283, 18.420733412577597, 18.932480851360864, 18.311518833972002, 19.14480691362133, 19.99875147850585, 20.80458271473818, 21.144975288093185, 21.563758834469024, 21.538560592468308, 23.622871253940243, 23.752536302681513, 24.615030089402623, 26.443222547101232, 27.164862782326466, 26.869855881431114, 25.07329470062618, 26.40509080499716, 25.00257333633167, 24.770439279994772, 23.521950528143737, 22.489870391790294, 22.64762235435388, 23.019932101562947, 21.60427462399272, 20.014938020518446, 20.59353817493906, 21.716497346644452, 20.80734133877936, 22.32437208539125, 21.834258147540254, 22.954205000596655, 22.499602741700453, 25.226754206489236, 26.353545336149658, 25.689103797063993, 27.071711717065845, 28.39289655239691, 29.35299145156725, 26.997767599079317, 28.13058829166791, 28.314436274313824, 28.36749044546162, 26.030234111529793, 27.322718513811495, 26.060320208759162, 24.01465483202487, 24.5404277844249, 23.591774019667103, 22.976202229924443, 23.182541554190735, 23.302347755265483, 22.22502488352512, 24.469284339664714, 23.879926500344627, 25.47710199355344, 26.346863413081188, 26.080164875440374, 26.728512681717337, 27.573941654416878, 29.90214105159591, 31.212809964521604, 29.226978068798882, 28.930520600499683, 29.120225403507572, 31.414735174896816, 29.115197962555087, 30.39265814945518, 28.785533732838502, 26.871680866575158, 26.684798647370602, 25.399930929603638, 25.94726863246417, 25.404632895062253, 25.510993693742005, 25.562450514275955, 24.754808216095594, 26.209165108286573, 25.124919334336127, 25.463147587774174, 26.857905118624867, 29.725641121747657, 28.439757046720548, 30.65671871203804, 30.36053812864386, 32.25749065466596, 31.890672388587625, 33.16366848043725, 33.06522222955012, 33.603593983443, 32.68822818101463, 30.999643278851604, 30.81814801023221, 30.881476573214716, 27.929042859514162, 29.230596628236235, 28.272560960001186, 26.197868725651254, 27.55944030325318, 26.342737886333676, 26.34356640272581, 27.958842107536604, 28.070358207185066, 28.498586597168508, 30.9522291429116, 30.864991894692178, 30.32846815002518, 33.40290958563308, 31.960535560130268, 34.43636345024768, 35.3804337815965, 33.85490872642675, 33.2814634433296, 32.68472786072359, 32.124784805972055, 33.16773260244735, 31.137077385340234, 32.55488755075471, 29.42899984162207, 31.17908429907809, 30.06527149082473, 29.731618422680466, 28.983540473157632, 27.452018644942843, 27.92187265786183, 29.359536795272152, 30.556673788329295, 29.965144680004364, 31.027338385411994, 32.354669684304774, 32.81146033892686, 32.881082589457066, 33.66380024388839, 34.04336690519633, 36.99777196156387, 35.23391673601377, 34.58060551174662, 35.20003472580764, 34.046647745659385, 33.877162377254166, 33.486804535777374, 33.759455003747156, 32.42032072488185, 32.26657916030224, 29.865504513808727, 32.347378699738535, 30.911926424767834, 29.98573056790137, 30.881367438349947, 31.332914157236647, 32.15703595136055, 34.29543057951845, 33.34138682367491, 33.46571115241755, 33.909687050837974, 35.36367806087536, 35.53866953975699, 36.48652669724706, 37.06227150671166, 38.047417261968626, 38.175757039008516, 36.655881886724764, 37.975672016928144, 36.5582645326452, 37.34060342329293, 33.765460682226106, 35.38595538518475, 34.743459816428974, 35.05523163530061, 34.50863581647429, 32.616094936867334, 31.99910557640537, 31.363908269748485, 31.829681265730947, 34.68996551233565, 33.06252540848116, 36.17090381735492, 36.82207724369582, 37.46046211677368, 38.753284165000075, 37.2587709046611, 40.01585673719755, 39.539920083198446, 41.02191170212454, 39.79733307399238, 40.30103454858682, 38.62954443428406, 38.76762641665626, 39.30286899531794, 38.71382215376212, 36.8842760014103, 36.73725435491935, 36.575859117836764, 35.71953146557672, 33.86391692863769, 33.84403154400341, 33.518699368208765, 36.4196850024074, 34.8403147822717, 35.88664901725848, 36.86330256023527, 39.071807018601575, 38.59940548941364, 40.104776420603216, 41.74075825945254, 42.01756672479821, 41.20243422937578, 41.794714807926006, 41.90258403801699, 40.06987214342271, 42.27916734128524, 42.51638010884479, 39.76026445761592, 39.685239440407464, 40.14771278792267, 36.924732993456175, 38.33827056569809, 38.284347435492, 35.710888252844896, 35.21793959041632, 35.31443749499509, 38.86179768433084, 39.446604398747496, 38.73945750410109, 39.1640299551801, 39.51774418043092, 40.5513976602587, 43.37867080058527, 43.67549182715042, 43.11290757582728, 46.01043339015902, 44.83932252790664, 44.23853109160756, 45.71601405032121, 41.4985935324989, 45.115545267985205, 42.49669201551448, 40.23952744825693, 42.19639694256013, 38.10070929952251, 40.07590432276917, 37.137396780832354, 38.837990762711954, 40.27595568187269, 39.80790325299423, 39.8832383201768, 40.17428057775011, 39.10125081151536, 41.439112538587494, 40.82376504654837, 44.904805387912354, 44.55800611759369, 46.16158167452794, 44.552208261111446, 46.488392949555994, 46.63096394901119, 48.53941117168033, 45.00274758209275, 43.56451178741356, 44.80330294772971, 43.25162984356727, 44.867918986472446, 42.2703714907869, 40.74385704281871, 43.244932217665266, 42.31288104309317, 39.036626545772755, 39.187168322282645, 42.28520536599954, 40.33603701051007, 42.181649678527435, 40.53254935738896, 42.72941143907184, 42.84561744797909, 44.5307843073794, 47.05021925483831, 46.12373954740964, 45.62914213047849, 48.276742521616, 50.06990283722697, 47.82795587428891, 46.42447631458568, 48.615497154232656, 46.518896311890245, 46.89133576772839, 47.70428269933418, 45.89986864353239, 45.778325428701514, 42.19156485933336, 41.20878163013045, 43.16652492562569, 41.06085521319854, 43.41017086386246, 44.95538958444429, 42.456459566242536, 45.632537489015064, 47.78250033174656, 46.315819283538985, 48.81428269551037, 48.50668000886227, 50.19079642310066, 50.16269221476183, 50.304123027492395, 49.1070075783346, 51.340379630637216, 50.36949860842993, 51.2364579943308, 48.96903707798736, 47.01332800178605, 48.448029801636466, 47.497909473366626, 44.962469474958155, 45.05324178194058, 46.0953439779628, 44.782172667730585, 43.10727640264083, 44.238184948891394, 44.61750467238064, 45.14656324062526, 48.536595510894074, 49.25692644361593, 46.432109615141314, 47.931543043850134, 51.22268730700843, 48.56166193047426, 53.00992355116285, 51.55330351515379, 51.21211683077039, 54.60757115061209, 50.47132305880377, 52.67054619931553, 51.68973933978891, 50.83818025278235, 48.829312010840916, 48.679593926111295, 45.58143977606478, 46.178990434762845, 45.444025426446636, 44.84509848222095, 47.641204166682535, 44.85581268572061, 45.445314531665694, 47.98852840953882, 50.12494448355544, 49.87677400761961, 51.78857928276875, 53.66417740720087, 52.62151314188721, 51.415549790828095, 51.51450989886734, 55.89453884086635, 52.70659345713841, 54.59268445108489, 55.03420967031169, 51.915441366896715, 50.91071924499365, 51.93300775846754, 52.98441613518421, 52.0344482386366, 51.85897596838499, 49.505730833325885, 51.087750203643736, 48.458660782497674, 49.58676379024657, 47.58067379238466, 51.38793775547676, 49.89480531590981, 48.20309463425001, 51.46576152981949, 51.8287553599165, 55.292701064471515, 52.977944045683586, 55.433491789666526, 55.54419968472813, 57.006109348541756, 55.47813007612471, 56.26744099665259, 54.81109445204887, 52.76261272372506, 52.759179234979094, 51.9189386220118, 55.3718241634044, 54.66212638445647, 49.97998429241412, 48.94014523913551, 51.393707519167286, 50.35328519096806, 49.68453611982053, 51.411990437764295, 52.992276027870396, 50.142804346689005, 52.47764078534571, 51.61177103440893, 56.502423024956656, 57.847651249313905, 56.666869243696844, 58.21502380019783, 60.34518070311136, 60.23309249652759, 59.397115258016925, 59.79871093893722, 58.88139784105108, 55.98684978180232, 56.384517099378755, 54.529045505551444, 54.25737424216005, 52.9099714586019, 52.4451475072708, 55.935611359775116, 51.80353649490985, 53.234850964399435, 53.352601262186205, 53.22041081244046, 51.33003204949658, 53.05028106494528, 55.14683692588862, 58.03015012232101, 55.14185305156147, 59.609983526632256, 58.65056315602457, 57.569956318443225, 57.219668310456605, 58.23749578391757, 58.51105021657801, 59.77578665330887, 58.52263990570722, 58.57352218017452, 59.574081953628216, 61.096019476242695, 58.88412051392649, 54.64854443965835, 56.06756289752757, 56.01051671762803, 54.24518480115429, 53.09907329823606, 56.64411562386984, 52.23612007973209]];
}

exports.handler({});